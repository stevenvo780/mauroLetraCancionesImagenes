import os
import config
from PIL import Image, ImageDraw, ImageFont
from diffusers import StableDiffusionXLPipeline
import torch
from local_model import LocalModel

local_model = LocalModel()

def generate_image_from_lyrics(lyrics: str) -> str:
    # Create a creative prompt from the lyrics using the local model
    prompt_input = (
        "Convert the following lyrics into a creative prompt for generating a high-quality digital image. "
        "Use descriptive language with artistic details, cinematic atmosphere, balanced composition, and vibrant colors. Lyrics: " + lyrics
    )
    creative_prompt = local_model.get_response(prompt_input)
    print("Generated creative prompt:", creative_prompt)
    if not creative_prompt:
        print("The model did not return a valid prompt.")
        return ""
    
    output_folder = "output"
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)
    
    # Determine which device to use
    if torch.cuda.is_available():
        device = "cuda"
        dtype_arg = {"torch_dtype": torch.float16}
    elif torch.backends.mps.is_available() and torch.backends.mps.is_built():
        device = "mps"
        dtype_arg = {"torch_dtype": torch.float16}
    else:
        device = "cpu"
        print("WARNING: No accelerator found. Running on CPU with default float32 precision (this may be very slow or may fail).")
        dtype_arg = {}  # Do not set float16 on CPU

    try:
        # Load the SDXL pipeline using the fp16 variant if accelerator is available
        pipe = StableDiffusionXLPipeline.from_pretrained(
            "stabilityai/stable-diffusion-xl-base-1.0",
            variant="fp16",             # Use the fp16 checkpoint variant
            use_safetensors=True,       # For faster and safer weight loading
            safety_checker=None,        # Optionally disable safety checker
            **dtype_arg
        )
        pipe = pipe.to(device)
        
        # Generate the image with a higher number of inference steps and guidance scale for improved quality
        image = pipe(
            prompt=creative_prompt,
            num_inference_steps=50,
            guidance_scale=8.0
        ).images[0]
        
        image_path = os.path.join(output_folder, "sd_output.png")
        image.save(image_path)
        return image_path
    except Exception as e:
        print("Error generating image:", e)
        return ""

def main():
    with open("lyrics.txt", "r", encoding="utf-8") as f:
        lyrics = f.read()
    
    # Create a local image with the lyrics text
    img = Image.new("RGB", (config.IMAGE_WIDTH, config.IMAGE_HEIGHT), color=config.BACKGROUND_COLOR)
    draw = ImageDraw.Draw(img)
    font_path = config.FONT_PATH
    if not os.path.exists(font_path):
        font = ImageFont.load_default()
    else:
        try:
            font = ImageFont.truetype(font_path, config.FONT_SIZE)
        except Exception:
            font = ImageFont.load_default()
    draw.multiline_text((50, 50), lyrics, font=font, fill=config.FONT_COLOR)
    
    output_folder = "output"
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)
    local_out = os.path.join(output_folder, config.OUTPUT_FILENAME)
    img.save(local_out)
    print("Local image generated:", local_out)
    
    image_path = generate_image_from_lyrics(lyrics)
    if image_path:
        print("Image generated by model:", image_path)
    else:
        print("Failed to generate image with the model.")

if __name__ == "__main__":
    main()
